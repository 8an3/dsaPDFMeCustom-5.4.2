<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Webpack App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body style="margin: 0">
    <div>
      <button onclick="saveTemplateByAPI()">saveTemplateByAPI</button>
      <button onclick="getTemplateFromLocalStorage()">getTemplateFromLocalStorage</button>
      /
      <button onclick="previewInit()">Init preview</button>
      <button onclick="editablePreviewInit()">Init editable preview</button>
      <button onclick="editorInit()">Init editor</button>
      /
      <button onclick="previewDestroy()">Destroy preview</button>
      <button onclick="editablePreviewDestroy()">Destroy editable preview</button>
      <button onclick="editorDestroy()">Destroy editor</button>
    </div>
    <div id="app"></div>
    <script>
      const domContainer = document.getElementById('app');
      const getSampleTemplate = () => ({
        columns: ['field1', 'field2'],
        sampledata: [
          {
            field1: 'bb',
            field2: 'aaaaaaaaaaaa',
          },
        ],
        fontName: '',
        basePdf: LabelmakeUi.blankPdf,
        schemas: [
          {
            field1: {
              type: 'text',
              position: { x: 20, y: 20 },
              width: 100,
              height: 15,
              alignment: 'left',
              fontSize: 30,
              characterSpacing: 0,
              lineHeight: 1,
            },
            field2: {
              type: 'text',
              position: { x: 20, y: 35 },
              width: 100,
              height: 40,
              alignment: 'left',
              fontSize: 20,
              characterSpacing: 0,
              lineHeight: 1,
            },
          },
        ],
      });
      const getSize = () => ({ height: 700, width: 700 });

      const inited = 'inited';
      const preview = 'preview';
      const editablePreview = 'editablePreview';
      const editor = 'editor';

      function init() {
        const item = localStorage.getItem(inited);
        if (item === preview) previewDestroy(), previewInit();
        if (item === editablePreview) editablePreviewDestroy(), editablePreviewInit();
        if (item === editor) editorDestroy(), editorInit();
      }

      window.onload = init;

      function saveTemplateByAPI() {
        fetch('https://api.labelmake.jp/v1/templates?team=labelmake', {
          method: 'GET',
          headers: {
            'X-Labelmake-API-Token': '',
          },
        })
          .then((response) => response.json())
          .then((json) => {
            alert('saved');
            localStorage.setItem('templates', JSON.stringify(json));
          });
      }

      function getTemplateFromLocalStorage() {
        const input = window.prompt('enter index');
        const templates = JSON.parse(localStorage.getItem('templates'));
        let template = null;
        if (isNaN(input)) {
          template = templates.find((t) => t.id === input);
        } else {
          template = templates[input];
        }
        if (!template) {
          alert('invalid input');
          return;
        }
        localStorage.setItem('template', JSON.stringify(template));
        init();
      }

      function previewInit() {
        localStorage.setItem(inited, preview);
        LabelmakeUi.Preview.init(
          domContainer,
          JSON.parse(localStorage.getItem('template')) || getSampleTemplate(),
          [
            { field1: 'ああ1', field2: 'いいいい1' },
            { field1: 'ああ2', field2: 'いいいい2' },
          ],
          getSize()
        );
      }
      function editablePreviewInit() {
        localStorage.setItem(inited, editablePreview);
        LabelmakeUi.Preview.init(
          domContainer,
          JSON.parse(localStorage.getItem('template')) || getSampleTemplate(),
          [
            { field1: 'ああ1', field2: 'いいいい1' },
            { field1: 'ああ2', field2: '' },
          ],
          getSize(),
          ({ index, value, key }) => {
            console.log('index', index, 'value', value, 'key', key);
          }
        );
      }
      function editorInit() {
        localStorage.setItem(inited, editor);
        const saveTemplate = (t) => {
          return new Promise((resolve) => {
            console.log(t);
            const blob = new Blob([JSON.stringify(t)], {
              type: 'application/json',
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `template.json`;
            link.click();
            URL.revokeObjectURL(url);
            resolve(t);
          });
        };
        LabelmakeUi.Editor.init(
          domContainer,
          JSON.parse(localStorage.getItem('template')) || getSampleTemplate(),
          saveTemplate,
          getSize()
        );
      }

      function previewDestroy() {
        LabelmakeUi.Preview.destroy();
      }
      function editablePreviewDestroy() {
        previewDestroy();
      }
      function editorDestroy() {
        LabelmakeUi.Editor.destroy();
      }
    </script>
  </body>
</html>
